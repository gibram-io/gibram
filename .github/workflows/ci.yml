name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Download dependencies
      run: go mod download

    - name: Run tests
      run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.txt
        flags: unittests
        name: codecov-${{ matrix.os }}

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m

  race-detector:
    name: Race Detector (Extended)
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Run race detector on critical packages
      run: |
        echo "=== Testing pkg/memory with race detector ==="
        go test -v -race -timeout=10m ./pkg/memory/...
        
        echo "=== Testing pkg/backup with race detector ==="
        go test -v -race -timeout=10m ./pkg/backup/...
        
        echo "=== Testing pkg/engine with race detector ==="
        go test -v -race -timeout=10m ./pkg/engine/...
        
        echo "=== Testing pkg/store with race detector ==="
        go test -v -race -timeout=10m ./pkg/store/...
        
        echo "=== Testing pkg/types with race detector ==="
        go test -v -race -timeout=10m ./pkg/types/...
        
        echo "=== Testing pkg/resilience with race detector ==="
        go test -v -race -timeout=10m ./pkg/resilience/...

    - name: Run integration tests with race detector
      run: go test -v -race -timeout=15m ./test/...

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Run benchmarks
      run: |
        go test -bench=. -benchmem -run=^$ ./pkg/memory/... > benchmark_memory.txt
        go test -bench=. -benchmem -run=^$ ./pkg/backup/... > benchmark_backup.txt
        go test -bench=. -benchmem -run=^$ ./pkg/types/... > benchmark_types.txt
        go test -bench=. -benchmem -run=^$ ./pkg/simd/... > benchmark_simd.txt

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_*.txt

  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod

    - name: Build
      run: go build -v ./...

    - name: Verify no uncommitted files
      run: |
        git diff --exit-code
        git status --porcelain | grep -q . && exit 1 || exit 0
